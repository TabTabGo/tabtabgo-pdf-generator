<?xml version="1.0" encoding="utf-8"?>
<!--
  web.config for TabTabGo PDF Generator
  
  This configuration file enables hosting of the Node.js application in IIS using iisnode.
  
  Prerequisites:
  - IIS with iisnode module installed
  - URL Rewrite module installed
  - Node.js installed on the server
  
  For detailed deployment instructions, see DEPLOYMENT_IIS.md
-->
<configuration>
  <system.webServer>
    
    <!-- 
      Handler configuration for iisnode
      Routes all requests to the Node.js application
    -->
    <handlers>
      <!-- Route all requests to Node.js via iisnode -->
      <add name="iisnode" path="src/index.js" verb="*" modules="iisnode" />
    </handlers>
    
    <!-- 
      URL Rewrite rules
      Ensures all requests are properly routed to the Node.js application
    -->
    <rewrite>
      <rules>
        <!-- Serve static files directly (if any) -->
        <rule name="StaticContent" stopProcessing="true">
          <match url="^(public/.*|.*\.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot))$" />
          <action type="Rewrite" url="{REQUEST_URI}" />
        </rule>
        
        <!-- Don't interfere with iisnode internals -->
        <rule name="iisnode" stopProcessing="true">
          <match url="src/index.js" />
          <action type="Rewrite" url="src/index.js" />
        </rule>
        
        <!-- Route all other requests to Node.js -->
        <rule name="DynamicContent" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          </conditions>
          <action type="Rewrite" url="src/index.js" />
        </rule>
      </rules>
    </rewrite>
    
    <!-- 
      iisnode configuration
      Optimized for production performance
      
      Note: nodeProcessCommandLine uses the default installation path for Node.js.
      If Node.js is installed in a custom location, update this path accordingly.
    -->
    <iisnode
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      nodeProcessCountPerApplication="0"
      maxConcurrentRequestsPerProcess="1024"
      maxNamedPipeConnectionRetry="24"
      namedPipeConnectionRetryDelay="250"
      maxNamedPipeConnectionPoolSize="512"
      maxNamedPipePooledConnectionAge="30000"
      asyncCompletionThreadCount="0"
      initialRequestBufferSize="4096"
      maxRequestBufferSize="65536"
      watchedFiles="*.js;iisnode.yml"
      loggingEnabled="false"
      logDirectory="iisnode"
      debuggingEnabled="false"
      devErrorsEnabled="false"
      flushResponse="false"
      enableXFF="true"
    />
    
    <!--
      For development/troubleshooting, you can temporarily enable logging:
      loggingEnabled="true"
      debuggingEnabled="true"
      
      IMPORTANT: Ensure loggingEnabled is set to "false" in production to avoid
      exposing sensitive information in logs. If logging is needed, ensure log
      files are properly secured and not accessible via HTTP.
    -->
    
    <!--
      Security settings
    -->
    <security>
      <requestFiltering>
        <!-- Increase maximum request length for large HTML content -->
        <requestLimits maxAllowedContentLength="52428800" /> <!-- 50 MB -->
      </requestFiltering>
    </security>
    
    <!--
      HTTP Protocol settings
    -->
    <httpProtocol>
      <customHeaders>
        <!-- Security headers -->
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="DENY" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <!-- Remove server information -->
        <remove name="X-Powered-By" />
      </customHeaders>
    </httpProtocol>
    
    <!--
      Static content settings (MIME types)
    -->
    <staticContent>
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
      <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
    </staticContent>
    
    <!--
      HTTP Compression
    -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    
    <!--
      HTTP Errors - Hide detailed error information in production
    -->
    <httpErrors existingResponse="PassThrough" />
    
  </system.webServer>
  
  <!--
    System.web configuration (for compatibility)
  -->
  <system.web>
    <!-- Set maximum request length (in KB) -->
    <httpRuntime maxRequestLength="51200" /> <!-- 50 MB -->
  </system.web>
  
</configuration>
